<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of exportModel</title>
  <meta name="keywords" content="exportModel">
  <meta name="description" content="exportModel">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">io</a> &gt; exportModel.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for io&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>exportModel
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>exportModel</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> exportModel
   Exports a constraint-based model to an SBML file (L3V1 FBCv2)

   Input:
   model               a model structure
   fileName            filename to export the model to (without file extension)
   exportGeneComplexes true if gene complexes (all gene sets linked with
                       AND relationship) should be recognised and exported
                       (opt, default false)
   supressWarnings     true if warnings should be supressed (opt, default
                       false)
   sortIds             logical whether metabolites, reactions and genes
                       should be sorted alphabetically by their
                       identifiers (opt, default false)

   Usage: exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>	checkFileExistence</li><li><a href="sortIdentifiers.html" class="code" title="function newModel = sortIdentifiers(model)">sortIdentifiers</a>	exportModel</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="SBMLFromExcel.html" class="code" title="function SBMLFromExcel(fileName, outputFileName,toCOBRA,printWarnings)">SBMLFromExcel</a>	SBMLFromExcel</li><li><a href="exportForGit.html" class="code" title="function out=exportForGit(model,prefix,path,formats,mainBranchFlag,subDirs,cobraText)">exportForGit</a>	exportForGit</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function modelSBML=getSBMLStructure(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions)</a></li><li><a href="#_sub2" class="code">function miriamString=getMiriam(miriamStruct)</a></li><li><a href="#_sub3" class="code">function [tmp_Rxn]=addReactantsProducts(model,sbmlModel,i)</a></li><li><a href="#_sub4" class="code">function vecT = columnVector(vec)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds)</a>
0002 <span class="comment">% exportModel</span>
0003 <span class="comment">%   Exports a constraint-based model to an SBML file (L3V1 FBCv2)</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   Input:</span>
0006 <span class="comment">%   model               a model structure</span>
0007 <span class="comment">%   fileName            filename to export the model to (without file extension)</span>
0008 <span class="comment">%   exportGeneComplexes true if gene complexes (all gene sets linked with</span>
0009 <span class="comment">%                       AND relationship) should be recognised and exported</span>
0010 <span class="comment">%                       (opt, default false)</span>
0011 <span class="comment">%   supressWarnings     true if warnings should be supressed (opt, default</span>
0012 <span class="comment">%                       false)</span>
0013 <span class="comment">%   sortIds             logical whether metabolites, reactions and genes</span>
0014 <span class="comment">%                       should be sorted alphabetically by their</span>
0015 <span class="comment">%                       identifiers (opt, default false)</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%   Usage: exportModel(model,fileName,exportGeneComplexes,supressWarnings,sortIds)</span>
0018 fileName=char(fileName);
0019 <span class="keyword">if</span> nargin&lt;3
0020     exportGeneComplexes=false;
0021 <span class="keyword">end</span>
0022 <span class="keyword">if</span> nargin&lt;4
0023     supressWarnings=false;
0024 <span class="keyword">end</span>
0025 <span class="keyword">if</span> nargin&lt;5
0026     sortIds=false;
0027 <span class="keyword">end</span>
0028 <span class="keyword">if</span> sortIds==true
0029     model=<a href="sortIdentifiers.html" class="code" title="function newModel = sortIdentifiers(model)">sortIdentifiers</a>(model);
0030 <span class="keyword">end</span>
0031 
0032 <span class="comment">%If no subSystems are defined, then no need to use groups package</span>
0033 <span class="keyword">if</span> isfield(model,<span class="string">'subSystems'</span>)
0034     modelHasSubsystems=true;
0035 <span class="keyword">else</span>
0036     modelHasSubsystems=false;
0037 <span class="keyword">end</span>
0038 
0039 <span class="comment">%The default SBML format settings, which are used as input for appropriate</span>
0040 <span class="comment">%libSBML functions to generate the blank SBML model structure before using</span>
0041 <span class="comment">%exporting in with OutputSBML to xml file</span>
0042 sbmlLevel=3;
0043 sbmlVersion=1;
0044 sbmlPackages={<span class="string">'fbc'</span>};
0045 sbmlPackageVersions=2;
0046 <span class="keyword">if</span> modelHasSubsystems
0047     sbmlPackages={sbmlPackages,<span class="string">'groups'</span>};
0048     sbmlPackageVersions=[sbmlPackageVersions,1];
0049 <span class="keyword">end</span>
0050 
0051 <span class="comment">%Check if the &quot;unconstrained&quot; field is still present. This shows if</span>
0052 <span class="comment">%exchange metabolites have been removed</span>
0053 <span class="keyword">if</span> ~isfield(model,<span class="string">'unconstrained'</span>)
0054     model.unconstrained=zeros(numel(model.mets),1);
0055 <span class="keyword">end</span>
0056 
0057 <span class="comment">%If model id and name do not exist, make sure that default</span>
0058 <span class="comment">%strings are included</span>
0059 <span class="keyword">if</span> ~isfield(model,<span class="string">'id'</span>)
0060     fprintf(<span class="string">'WARNING: The model is missing the &quot;id&quot; field. Uses &quot;blankID&quot;. \n'</span>);
0061     model.id=<span class="string">'blankID'</span>;
0062 <span class="keyword">end</span>
0063 <span class="keyword">if</span> ~isfield(model,<span class="string">'name'</span>)
0064     fprintf(<span class="string">'WARNING: The model is missing the &quot;name&quot; field. Uses &quot;blankName&quot;. \n'</span>);
0065     model.name=<span class="string">'blankName'</span>;
0066 <span class="keyword">end</span>
0067 
0068 <span class="comment">%Check the model structure</span>
0069 <span class="keyword">if</span> supressWarnings==false
0070     checkModelStruct(model,false);
0071 <span class="keyword">end</span>
0072 
0073 <span class="comment">%Add several blank fields, if they do not exist already. This is to reduce</span>
0074 <span class="comment">%the number of conditions below</span>
0075 <span class="keyword">if</span> ~isfield(model,<span class="string">'compMiriams'</span>)
0076     model.compMiriams=cell(numel(model.comps),1);
0077 <span class="keyword">end</span>
0078 <span class="keyword">if</span> ~isfield(model,<span class="string">'inchis'</span>)
0079     model.inchis=cell(numel(model.mets),1);
0080 <span class="keyword">end</span>
0081 <span class="keyword">if</span> ~isfield(model,<span class="string">'metFormulas'</span>)
0082     model.metFormulas=cell(numel(model.mets),1);
0083 <span class="keyword">end</span>
0084 <span class="keyword">if</span> ~isfield(model,<span class="string">'metMiriams'</span>)
0085     model.metMiriams=cell(numel(model.mets),1);
0086 <span class="keyword">end</span>
0087 <span class="keyword">if</span> ~isfield(model,<span class="string">'geneMiriams'</span>) &amp;&amp; isfield(model,<span class="string">'genes'</span>)
0088     model.geneMiriams=cell(numel(model.genes),1);
0089 <span class="keyword">end</span>
0090 <span class="keyword">if</span> ~isfield(model,<span class="string">'geneShortNames'</span>) &amp;&amp; isfield(model,<span class="string">'genes'</span>)
0091     model.geneShortNames=cell(numel(model.genes),1);
0092 <span class="keyword">end</span>
0093 <span class="keyword">if</span> ~isfield(model,<span class="string">'subSystems'</span>)
0094     model.subSystems=cell(numel(model.rxns),1);
0095 <span class="keyword">end</span>
0096 <span class="keyword">if</span> ~isfield(model,<span class="string">'eccodes'</span>)
0097     model.eccodes=cell(numel(model.rxns),1);
0098 <span class="keyword">end</span>
0099 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnReferences'</span>)
0100     model.rxnReferences=cell(numel(model.rxns),1);
0101 <span class="keyword">end</span>
0102 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnConfidenceScores'</span>)
0103     model.rxnConfidenceScores=NaN(numel(model.rxns),1);
0104 <span class="keyword">end</span>
0105 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnNotes'</span>)
0106     model.rxnNotes=cell(numel(model.rxns),1);
0107 <span class="keyword">end</span>
0108 <span class="keyword">if</span> ~isfield(model,<span class="string">'rxnMiriams'</span>)
0109     model.rxnMiriams=cell(numel(model.rxns),1);
0110 <span class="keyword">end</span>
0111 
0112 <span class="keyword">if</span> sbmlLevel&lt;3
0113     <span class="comment">%Check if genes have associated compartments</span>
0114     <span class="keyword">if</span> ~isfield(model,<span class="string">'geneComps'</span>) &amp;&amp; isfield(model,<span class="string">'genes'</span>)
0115         <span class="keyword">if</span> supressWarnings==false
0116             EM=<span class="string">'There are no compartments specified for genes. All genes will be assigned to the first compartment. This is because the SBML structure requires all elements to be assigned to a compartment'</span>;
0117             dispEM(EM,false);
0118         <span class="keyword">end</span>
0119         model.geneComps=ones(numel(model.genes),1);
0120     <span class="keyword">end</span>
0121 <span class="keyword">end</span>
0122 
0123 <span class="comment">%Convert ids to SBML-convenient format. This is to avoid the data loss when</span>
0124 <span class="comment">%unsupported characters are included in ids. Here we are using part from</span>
0125 <span class="comment">%convertSBMLID, originating from the COBRA Toolbox</span>
0126 model.rxns=regexprep(model.rxns,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0127 model.mets=regexprep(model.mets,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0128 model.comps=regexprep(model.comps,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0129 <span class="keyword">if</span> isfield(model,<span class="string">'genes'</span>)
0130     problemGenes=find(~cellfun(<span class="string">'isempty'</span>,regexp(model.genes,<span class="string">'([^0-9_a-zA-Z])'</span>)));
0131     originalGenes=model.genes(problemGenes);
0132     replacedGenes=regexprep(model.genes(problemGenes),<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0133     model.genes(problemGenes)=replacedGenes;
0134     <span class="keyword">for</span> i=1:numel(problemGenes)
0135         model.grRules = regexprep(model.grRules, [<span class="string">'(^|\s|\()'</span> originalGenes{i} <span class="string">'($|\s|\))'</span>], [<span class="string">'$1'</span> replacedGenes{i} <span class="string">'$2'</span>]);
0136     <span class="keyword">end</span>
0137 <span class="keyword">end</span>
0138 
0139 <span class="comment">%Generate an empty SBML structure</span>
0140 modelSBML=<a href="#_sub1" class="code" title="subfunction modelSBML=getSBMLStructure(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions)">getSBMLStructure</a>(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0141 modelSBML.metaid=model.id;
0142 modelSBML.id=regexprep(model.id,<span class="string">'([^0-9_a-zA-Z])'</span>,<span class="string">'__${num2str($1+0)}__'</span>);
0143 modelSBML.name=model.name;
0144 
0145 <span class="keyword">if</span> isfield(model,<span class="string">'annotation'</span>)
0146     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'note'</span>)
0147         modelSBML.notes=[<span class="string">'&lt;notes&gt;&lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;p&gt;'</span>,regexprep(model.annotation.note,<span class="string">'&lt;p&gt;|&lt;/p&gt;'</span>,<span class="string">''</span>),<span class="string">'&lt;/p&gt;&lt;/body&gt;&lt;/notes&gt;'</span>];
0148     <span class="keyword">end</span>
0149 <span class="keyword">else</span>
0150     modelSBML.notes=<span class="string">'&lt;notes&gt;&lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;p&gt;This file was generated using the exportModel function in RAVEN Toolbox 2 and OutputSBML in libSBML &lt;/p&gt;&lt;/body&gt;&lt;/notes&gt;'</span>;
0151 <span class="keyword">end</span>
0152 
0153 modelSBML.annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_'</span> model.id <span class="string">'&quot;&gt;'</span>];
0154 <span class="keyword">if</span> isfield(model,<span class="string">'annotation'</span>)
0155     nameString=<span class="string">''</span>;
0156     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'familyName'</span>)
0157         <span class="keyword">if</span> ~isempty(model.annotation.familyName)
0158             nameString=[<span class="string">'&lt;vCard:Family&gt;'</span> model.annotation.familyName <span class="string">'&lt;/vCard:Family&gt;'</span>];
0159         <span class="keyword">end</span>
0160     <span class="keyword">end</span>
0161     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'givenName'</span>)
0162         <span class="keyword">if</span> ~isempty(model.annotation.givenName)
0163             nameString=[nameString <span class="string">'&lt;vCard:Given&gt;'</span> model.annotation.givenName <span class="string">'&lt;/vCard:Given&gt;'</span>];
0164         <span class="keyword">end</span>
0165     <span class="keyword">end</span>
0166     email=<span class="string">''</span>;
0167     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'email'</span>)
0168         <span class="keyword">if</span> ~isempty(model.annotation.email)
0169             email=[<span class="string">'&lt;vCard:EMAIL&gt;'</span> model.annotation.email <span class="string">'&lt;/vCard:EMAIL&gt;'</span>];
0170         <span class="keyword">end</span>
0171     <span class="keyword">end</span>
0172     org=<span class="string">''</span>;
0173     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'organization'</span>)
0174         <span class="keyword">if</span> ~isempty(model.annotation.organization)
0175             org=[<span class="string">'&lt;vCard:ORG rdf:parseType=&quot;Resource&quot;&gt;&lt;vCard:Orgname&gt;'</span> model.annotation.organization <span class="string">'&lt;/vCard:Orgname&gt;&lt;/vCard:ORG&gt;'</span>];
0176         <span class="keyword">end</span>
0177     <span class="keyword">end</span>
0178     <span class="keyword">if</span> ~isempty(nameString) || ~isempty(email) || ~isempty(org)
0179         modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;dc:creator&gt;&lt;rdf:Bag&gt;&lt;rdf:li rdf:parseType=&quot;Resource&quot;&gt;'</span>];
0180         <span class="keyword">if</span> ~isempty(nameString)
0181             modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;vCard:N rdf:parseType=&quot;Resource&quot;&gt;'</span> nameString <span class="string">'&lt;/vCard:N&gt;'</span>];
0182         <span class="keyword">end</span>
0183         modelSBML.annotation=[modelSBML.annotation email org <span class="string">'&lt;/rdf:li&gt;&lt;/rdf:Bag&gt;&lt;/dc:creator&gt;'</span>];
0184     <span class="keyword">end</span>
0185 <span class="keyword">end</span>
0186 modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;dcterms:created rdf:parseType=&quot;Resource&quot;&gt;'</span><span class="keyword">...</span>
0187     <span class="string">'&lt;dcterms:W3CDTF&gt;'</span> datestr(now,<span class="string">'yyyy-mm-ddTHH:MM:SSZ'</span>) <span class="string">'&lt;/dcterms:W3CDTF&gt;'</span><span class="keyword">...</span>
0188     <span class="string">'&lt;/dcterms:created&gt;'</span><span class="keyword">...</span>
0189     <span class="string">'&lt;dcterms:modified rdf:parseType=&quot;Resource&quot;&gt;'</span><span class="keyword">...</span>
0190     <span class="string">'&lt;dcterms:W3CDTF&gt;'</span> datestr(now,<span class="string">'yyyy-mm-ddTHH:MM:SSZ'</span>) <span class="string">'&lt;/dcterms:W3CDTF&gt;'</span><span class="keyword">...</span>
0191     <span class="string">'&lt;/dcterms:modified&gt;'</span>];
0192 
0193 <span class="keyword">if</span> isfield(model,<span class="string">'annotation'</span>)
0194     <span class="keyword">if</span> isfield(model.annotation,<span class="string">'taxonomy'</span>)
0195         modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;&lt;rdf:li rdf:resource=&quot;https://identifiers.org/taxonomy/'</span> regexprep(model.annotation.taxonomy,<span class="string">'taxonomy/'</span>,<span class="string">''</span>) <span class="string">'&quot;/&gt;&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;'</span>];
0196     <span class="keyword">end</span>
0197 <span class="keyword">end</span>
0198 modelSBML.annotation=[modelSBML.annotation <span class="string">'&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0199 
0200 <span class="comment">%Prepare compartments</span>
0201 <span class="keyword">for</span> i=1:numel(model.comps)
0202     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0203     <span class="keyword">if</span> i==1
0204         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'sboTerm'</span>)
0205             modelSBML.compartment(i).sboTerm=290;
0206         <span class="keyword">end</span>
0207         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'spatialDimensions'</span>)
0208             modelSBML.compartment(i).spatialDimensions=3;
0209         <span class="keyword">end</span>
0210         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'size'</span>)
0211             modelSBML.compartment(i).size=1;
0212         <span class="keyword">end</span>
0213         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'constant'</span>)
0214             modelSBML.compartment(i).constant=1;
0215         <span class="keyword">end</span>
0216         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'isSetSize'</span>)
0217             modelSBML.compartment(i).isSetSize=1;
0218         <span class="keyword">end</span>
0219         <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'isSetSpatialDimensions'</span>)
0220             modelSBML.compartment(i).isSetSpatialDimensions=1;
0221         <span class="keyword">end</span>
0222     <span class="keyword">end</span>
0223     <span class="comment">%Copy the default values to the next entry as long as it is not the</span>
0224     <span class="comment">%last one</span>
0225     <span class="keyword">if</span> i&lt;numel(model.comps)
0226         modelSBML.compartment(i+1)=modelSBML.compartment(i);
0227     <span class="keyword">end</span>
0228     
0229     <span class="keyword">if</span> isfield(modelSBML.compartment,<span class="string">'metaid'</span>)
0230         <span class="keyword">if</span> regexp(model.comps{i},<span class="string">'^[^a-zA-Z_]'</span>)
0231             EM=<span class="string">'The compartment IDs are in numeric format. For the compliance with SBML specifications, compartment IDs will be preceded with &quot;c_&quot; string'</span>;
0232             dispEM(EM,false);
0233             model.comps(i)=strcat(<span class="string">'c_'</span>,model.comps(i));
0234         <span class="keyword">end</span>
0235         modelSBML.compartment(i).metaid=model.comps{i};
0236     <span class="keyword">end</span>
0237     <span class="comment">%Prepare Miriam strings</span>
0238     <span class="keyword">if</span> ~isempty(model.compMiriams{i})
0239         [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.compMiriams{i}.name);
0240         <span class="keyword">if</span> sbo_ind &gt; 0
0241             modelSBML.compartment(i).sboTerm=str2double(regexprep(model.compMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0242             <span class="comment">% remove the SBO term from compMiriams so the information is</span>
0243             <span class="comment">% not duplicated in the &quot;annotation&quot; field later on</span>
0244             model.compMiriams{i}.name(sbo_ind) = [];
0245             model.compMiriams{i}.value(sbo_ind) = [];
0246         <span class="keyword">end</span>
0247     <span class="keyword">end</span>
0248     <span class="keyword">if</span> ~isempty(model.compMiriams{i}) &amp;&amp; isfield(modelSBML.compartment(i),<span class="string">'annotation'</span>)
0249         modelSBML.compartment(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_'</span> model.comps{i} <span class="string">'&quot;&gt;'</span>];
0250         modelSBML.compartment(i).annotation=[modelSBML.compartment(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0251         modelSBML.compartment(i).annotation=[modelSBML.compartment(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.compMiriams{i}) <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0252     <span class="keyword">end</span>
0253     <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'name'</span>)
0254         modelSBML.compartment(i).name=model.compNames{i};
0255     <span class="keyword">end</span>
0256     <span class="keyword">if</span> isfield(modelSBML.compartment, <span class="string">'id'</span>)
0257         modelSBML.compartment(i).id=model.comps{i};
0258     <span class="keyword">end</span>
0259     
0260 <span class="keyword">end</span>
0261 
0262 <span class="comment">%Begin writing species</span>
0263 <span class="keyword">for</span> i=1:numel(model.mets)
0264     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0265     <span class="keyword">if</span> i==1
0266         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'sboTerm'</span>)
0267             modelSBML.species(i).sboTerm=247;
0268         <span class="keyword">end</span>
0269         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'initialAmount'</span>)
0270             modelSBML.species(i).initialAmount=1;
0271         <span class="keyword">end</span>
0272         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'initialConcentration'</span>)
0273             modelSBML.species(i).initialConcentration=0;
0274         <span class="keyword">end</span>
0275         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'isSetInitialAmount'</span>)
0276             modelSBML.species(i).isSetInitialAmount=1;
0277         <span class="keyword">end</span>
0278         <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'isSetInitialConcentration'</span>)
0279             modelSBML.species(i).isSetInitialConcentration=1;
0280         <span class="keyword">end</span>
0281     <span class="keyword">end</span>
0282     <span class="comment">%Copy the default values to the next entry as long as it is not the</span>
0283     <span class="comment">%last one</span>
0284     <span class="keyword">if</span> i&lt;numel(model.mets)
0285         modelSBML.species(i+1)=modelSBML.species(i);
0286     <span class="keyword">end</span>
0287     
0288     <span class="keyword">if</span> isfield(modelSBML.species,<span class="string">'metaid'</span>)
0289         modelSBML.species(i).metaid=[<span class="string">'M_'</span> model.mets{i}];
0290     <span class="keyword">end</span>
0291     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'name'</span>)
0292         modelSBML.species(i).name=model.metNames{i};
0293     <span class="keyword">end</span>
0294     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'id'</span>)
0295         modelSBML.species(i).id=[<span class="string">'M_'</span> model.mets{i}];
0296     <span class="keyword">end</span>
0297     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'compartment'</span>)
0298         modelSBML.species(i).compartment=model.comps{model.metComps(i)};
0299     <span class="keyword">end</span>
0300     <span class="keyword">if</span> isfield(model,<span class="string">'unconstrained'</span>)
0301         <span class="keyword">if</span> model.unconstrained(i)
0302             modelSBML.species(i).boundaryCondition=1;
0303         <span class="keyword">end</span>
0304     <span class="keyword">end</span>
0305     <span class="keyword">if</span> isfield(modelSBML.species, <span class="string">'fbc_charge'</span>) &amp;&amp; isfield(model,<span class="string">'metCharges'</span>)
0306         <span class="keyword">if</span> ~isnan(model.metCharges(i))
0307             modelSBML.species(i).fbc_charge=model.metCharges(i);
0308             modelSBML.species(i).isSetfbc_charge=1;
0309         <span class="keyword">else</span>
0310             modelSBML.species(i).isSetfbc_charge=0;
0311         <span class="keyword">end</span>
0312     <span class="keyword">end</span>
0313     <span class="keyword">if</span> ~isempty(model.metMiriams{i})
0314         [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.metMiriams{i}.name);
0315         <span class="keyword">if</span> sbo_ind &gt; 0
0316             modelSBML.species(i).sboTerm=str2double(regexprep(model.metMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0317             <span class="comment">% remove the SBO term from metMiriams so the information is</span>
0318             <span class="comment">% not duplicated in the &quot;annotation&quot; field later on</span>
0319             model.metMiriams{i}.name(sbo_ind) = [];
0320             model.metMiriams{i}.value(sbo_ind) = [];
0321         <span class="keyword">end</span>
0322     <span class="keyword">end</span>
0323     <span class="keyword">if</span> isfield(modelSBML.species,<span class="string">'annotation'</span>)
0324         <span class="keyword">if</span> ~isempty(model.metMiriams{i}) || ~isempty(model.metFormulas{i})
0325             hasInchi=false;
0326             <span class="keyword">if</span> ~isempty(model.metFormulas{i})
0327                 <span class="comment">%Only export formula if there is no InChI. This is because</span>
0328                 <span class="comment">%the metFormulas field is populated by InChIs if available</span>
0329                 <span class="keyword">if</span> ~isempty(model.inchis{i})
0330                     hasInchi=true;
0331                 <span class="keyword">end</span>
0332                 <span class="keyword">if</span> hasInchi==false
0333                     modelSBML.species(i).fbc_chemicalFormula=model.metFormulas{i};
0334                 <span class="keyword">end</span>
0335             <span class="keyword">end</span>
0336             <span class="keyword">if</span> ~isempty(model.metMiriams{i}) || hasInchi==true
0337                 modelSBML.species(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_M_'</span> model.mets{i} <span class="string">'&quot;&gt;'</span>];
0338                 modelSBML.species(i).annotation=[modelSBML.species(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0339                 <span class="keyword">if</span> ~isempty(model.metMiriams{i})
0340                     modelSBML.species(i).annotation=[modelSBML.species(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.metMiriams{i})];
0341                 <span class="keyword">end</span>
0342                 <span class="keyword">if</span> hasInchi==true
0343                     modelSBML.species(i).annotation=[modelSBML.species(i).annotation <span class="string">'&lt;rdf:li rdf:resource=&quot;https://identifiers.org/inchi/InChI='</span> regexprep(model.inchis{i},<span class="string">'^InChI='</span>,<span class="string">''</span>) <span class="string">'&quot;/&gt;'</span>];
0344                     modelSBML.species(i).fbc_chemicalFormula=char(regexp(model.inchis{i}, <span class="string">'/(\w+)/'</span>, <span class="string">'tokens'</span>, <span class="string">'once'</span>));
0345                 <span class="keyword">end</span>
0346                 modelSBML.species(i).annotation=[modelSBML.species(i).annotation <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0347             <span class="keyword">end</span>
0348         <span class="keyword">end</span>
0349     <span class="keyword">end</span>
0350 <span class="keyword">end</span>
0351 
0352 <span class="keyword">if</span> isfield(model,<span class="string">'genes'</span>)
0353     <span class="keyword">for</span> i=1:numel(model.genes)
0354         <span class="comment">%Add the default values, as these will be the same in all entries</span>
0355         <span class="keyword">if</span> i==1
0356             <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct, <span class="string">'sboTerm'</span>)
0357                 modelSBML.fbc_geneProduct(i).sboTerm=243;
0358             <span class="keyword">end</span>
0359         <span class="keyword">end</span>
0360         <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0361         <span class="comment">%last one</span>
0362         <span class="keyword">if</span> i&lt;numel(model.genes)
0363             modelSBML.fbc_geneProduct(i+1)=modelSBML.fbc_geneProduct(i);
0364         <span class="keyword">end</span>
0365         
0366         <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'metaid'</span>)
0367             modelSBML.fbc_geneProduct(i).metaid=model.genes{i};
0368         <span class="keyword">end</span>
0369         <span class="keyword">if</span> ~isempty(model.geneMiriams{i})
0370             [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.geneMiriams{i}.name);
0371             <span class="keyword">if</span> sbo_ind &gt; 0
0372                 modelSBML.fbc_geneProduct(i).sboTerm=str2double(regexprep(model.geneMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0373                 <span class="comment">% remove the SBO term from compMiriams so the information is</span>
0374                 <span class="comment">% not duplicated in the &quot;annotation&quot; field later on</span>
0375                 model.geneMiriams{i}.name(sbo_ind) = [];
0376                 model.geneMiriams{i}.value(sbo_ind) = [];
0377             <span class="keyword">end</span>
0378         <span class="keyword">end</span>
0379         <span class="keyword">if</span> ~isempty(model.geneMiriams{i}) &amp;&amp; isfield(modelSBML.fbc_geneProduct(i),<span class="string">'annotation'</span>)
0380             modelSBML.fbc_geneProduct(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_'</span> model.genes{i} <span class="string">'&quot;&gt;'</span>];
0381             modelSBML.fbc_geneProduct(i).annotation=[modelSBML.fbc_geneProduct(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0382             modelSBML.fbc_geneProduct(i).annotation=[modelSBML.fbc_geneProduct(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.geneMiriams{i}) <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0383         <span class="keyword">end</span>
0384         <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct, <span class="string">'fbc_id'</span>)
0385             modelSBML.fbc_geneProduct(i).fbc_id=model.genes{i};
0386         <span class="keyword">end</span>
0387         <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct, <span class="string">'fbc_label'</span>) &amp;&amp; isfield(model,<span class="string">'geneShortNames'</span>)
0388             <span class="keyword">if</span> isempty(model.geneShortNames{i})
0389                 modelSBML.fbc_geneProduct(i).fbc_label=model.genes{i};
0390             <span class="keyword">else</span>
0391                 modelSBML.fbc_geneProduct(i).fbc_label=model.geneShortNames{i};
0392             <span class="keyword">end</span>
0393         <span class="keyword">end</span>
0394     <span class="keyword">end</span>
0395     <span class="keyword">if</span> exportGeneComplexes==true
0396         <span class="comment">%Also add the complexes as genes. This is done by splitting grRules</span>
0397         <span class="comment">%on &quot;or&quot; and adding the ones which contain several genes</span>
0398         geneComplexes={};
0399         <span class="keyword">if</span> isfield(model,<span class="string">'grRules'</span>)
0400             <span class="comment">%Only grRules which contain &quot; and &quot; can be complexes</span>
0401             uniqueRules=unique(model.grRules);
0402             I=cellfun(@any,strfind(uniqueRules,<span class="string">' and '</span>));
0403             uniqueRules(~I)=[];
0404             uniqueRules=strrep(uniqueRules,<span class="string">'('</span>,<span class="string">''</span>);
0405             uniqueRules=strrep(uniqueRules,<span class="string">')'</span>,<span class="string">''</span>);
0406             uniqueRules=strrep(uniqueRules,<span class="string">' and '</span>,<span class="string">':'</span>);
0407             <span class="keyword">for</span> i=1:numel(uniqueRules)
0408                 genes=regexp(uniqueRules(i),<span class="string">' or '</span>,<span class="string">'split'</span>);
0409                 genes=genes{1}(:);
0410                 <span class="comment">%Check which ones are complexes</span>
0411                 I=cellfun(@any,strfind(genes,<span class="string">':'</span>));
0412                 geneComplexes=[geneComplexes;genes(I)];
0413             <span class="keyword">end</span>
0414         <span class="keyword">end</span>
0415         geneComplexes=unique(geneComplexes);
0416         <span class="keyword">if</span> ~isempty(geneComplexes)
0417             <span class="comment">%Then add them as genes. There is a possiblity that a complex</span>
0418             <span class="comment">%A&amp;B is added as separate from B&amp;A. This is not really an issue</span>
0419             <span class="comment">%so this is not dealt with</span>
0420             <span class="keyword">for</span> i=1:numel(geneComplexes)
0421                 modelSBML.fbc_geneProduct(numel(model.genes)+i)=modelSBML.fbc_geneProduct(1);
0422                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'metaid'</span>)
0423                     modelSBML.fbc_geneProduct(numel(model.genes)+i).metaid=geneComplexes{i};
0424                 <span class="keyword">end</span>
0425                 <span class="keyword">if</span> isfield(modelSBML.fbc_geneProduct,<span class="string">'fbc_id'</span>)
0426                     modelSBML.fbc_geneProduct(numel(model.genes)+i).fbc_id=geneComplexes{i};
0427                 <span class="keyword">else</span>
0428                     modelSBML.fbc_geneProduct(i).fbc_label=modelSBML.fbc_geneProduct(i).fbc_id;
0429                 <span class="keyword">end</span>
0430             <span class="keyword">end</span>
0431         <span class="keyword">end</span>
0432     <span class="keyword">end</span>
0433 <span class="keyword">end</span>
0434 
0435 <span class="comment">%Generate a list of unique fbc_bound names</span>
0436 totalValues=[model.lb; model.ub];
0437 totalNames=cell(size(totalValues,1),1);
0438 
0439 listUniqueValues=unique(totalValues);
0440 
0441 <span class="keyword">for</span> i=1:length(listUniqueValues)
0442     listUniqueNames{i,1}=[<span class="string">'FB'</span>,num2str(i),<span class="string">'N'</span>,num2str(abs(round(listUniqueValues(i))))]; <span class="comment">% create unique flux bound IDs.</span>
0443     ind=find(ismember(totalValues,listUniqueValues(i)));
0444     totalNames(ind)=listUniqueNames(i,1);
0445 <span class="keyword">end</span>
0446 
0447 <span class="keyword">for</span> i=1:length(listUniqueNames)
0448     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0449     <span class="keyword">if</span> i==1
0450         <span class="keyword">if</span> isfield(modelSBML.parameter, <span class="string">'constant'</span>)
0451             modelSBML.parameter(i).constant=1;
0452         <span class="keyword">end</span>
0453         <span class="keyword">if</span> isfield(modelSBML.parameter, <span class="string">'isSetValue'</span>)
0454             modelSBML.parameter(i).isSetValue=1;
0455         <span class="keyword">end</span>
0456     <span class="keyword">end</span>
0457     <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0458     <span class="comment">%last one</span>
0459     <span class="keyword">if</span> i&lt;numel(listUniqueNames)
0460         modelSBML.parameter(i+1)=modelSBML.parameter(i);
0461     <span class="keyword">end</span>
0462     modelSBML.parameter(i).id=listUniqueNames{i};
0463     modelSBML.parameter(i).value=listUniqueValues(i);
0464 <span class="keyword">end</span>
0465 
0466 <span class="keyword">for</span> i=1:numel(model.rxns)
0467     <span class="comment">%Add the default values, as these will be the same in all entries</span>
0468     <span class="keyword">if</span> i==1
0469         <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'sboTerm'</span>)
0470             modelSBML.reaction(i).sboTerm=176;
0471         <span class="keyword">end</span>
0472         <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'isSetFast'</span>)
0473             modelSBML.reaction(i).isSetFast=1;
0474         <span class="keyword">end</span>
0475     <span class="keyword">end</span>
0476     <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0477     <span class="comment">%last one</span>
0478     <span class="keyword">if</span> i&lt;numel(model.rxns)
0479         modelSBML.reaction(i+1)=modelSBML.reaction(i);
0480     <span class="keyword">end</span>
0481     
0482     <span class="keyword">if</span> isfield(modelSBML.reaction,<span class="string">'metaid'</span>)
0483         modelSBML.reaction(i).metaid=[<span class="string">'R_'</span> model.rxns{i}];
0484     <span class="keyword">end</span>
0485     
0486     <span class="comment">%Export notes information</span>
0487     <span class="keyword">if</span> (~isnan(model.rxnConfidenceScores(i)) || ~isempty(model.rxnReferences{i}) || ~isempty(model.rxnNotes{i}))
0488         modelSBML.reaction(i).notes=<span class="string">'&lt;notes&gt;&lt;body xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;'</span>;
0489         <span class="keyword">if</span> ~isnan(model.rxnConfidenceScores(i))
0490             modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;p&gt;Confidence Level: '</span> num2str(model.rxnConfidenceScores(i)) <span class="string">'&lt;/p&gt;'</span>];
0491         <span class="keyword">end</span>
0492         <span class="keyword">if</span> ~isempty(model.rxnReferences{i})
0493             modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;p&gt;AUTHORS: '</span> model.rxnReferences{i} <span class="string">'&lt;/p&gt;'</span>];
0494         <span class="keyword">end</span>
0495         <span class="keyword">if</span> ~isempty(model.rxnNotes{i})
0496             modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;p&gt;NOTES: '</span> model.rxnNotes{i} <span class="string">'&lt;/p&gt;'</span>];
0497         <span class="keyword">end</span>
0498         modelSBML.reaction(i).notes=[modelSBML.reaction(i).notes <span class="string">'&lt;/body&gt;&lt;/notes&gt;'</span>];
0499     <span class="keyword">end</span>
0500     
0501     <span class="comment">% Export SBO terms from rxnMiriams</span>
0502     <span class="keyword">if</span> ~isempty(model.rxnMiriams{i})
0503         [~,sbo_ind] = ismember(<span class="string">'sbo'</span>,model.rxnMiriams{i}.name);
0504         <span class="keyword">if</span> sbo_ind &gt; 0
0505             modelSBML.reaction(i).sboTerm=str2double(regexprep(model.rxnMiriams{i}.value{sbo_ind},<span class="string">'SBO:'</span>,<span class="string">''</span>,<span class="string">'ignorecase'</span>));
0506             <span class="comment">% remove the SBO term from rxnMiriams so the information is not</span>
0507             <span class="comment">% duplicated in the &quot;annotation&quot; field later on</span>
0508             model.rxnMiriams{i}.name(sbo_ind) = [];
0509             model.rxnMiriams{i}.value(sbo_ind) = [];
0510         <span class="keyword">end</span>
0511     <span class="keyword">end</span>
0512     
0513     <span class="comment">%Export annotation information from rxnMiriams</span>
0514     <span class="keyword">if</span> (~isempty(model.rxnMiriams{i}) &amp;&amp; isfield(modelSBML.reaction(i),<span class="string">'annotation'</span>)) || ~isempty(model.eccodes{i})
0515         modelSBML.reaction(i).annotation=[<span class="string">'&lt;annotation&gt;&lt;rdf:RDF xmlns:rdf=&quot;http://www.w3.org/1999/02/22-rdf-syntax-ns#&quot; xmlns:dc=&quot;http://purl.org/dc/elements/1.1/&quot; xmlns:dcterms=&quot;http://purl.org/dc/terms/&quot; xmlns:vCard=&quot;http://www.w3.org/2001/vcard-rdf/3.0#&quot; xmlns:bqbiol=&quot;http://biomodels.net/biology-qualifiers/&quot; xmlns:bqmodel=&quot;http://biomodels.net/model-qualifiers/&quot;&gt;&lt;rdf:Description rdf:about=&quot;#meta_R_'</span> model.rxns{i} <span class="string">'&quot;&gt;'</span>];
0516         modelSBML.reaction(i).annotation=[modelSBML.reaction(i).annotation <span class="string">'&lt;bqbiol:is&gt;&lt;rdf:Bag&gt;'</span>];
0517         <span class="keyword">if</span> ~isempty(model.eccodes{i})
0518             eccodes=regexp(model.eccodes{i},<span class="string">';'</span>,<span class="string">'split'</span>);
0519             <span class="keyword">for</span> j=1:numel(eccodes)
0520                 modelSBML.reaction(i).annotation=[modelSBML.reaction(i).annotation  <span class="string">'&lt;rdf:li rdf:resource=&quot;https://identifiers.org/ec-code/'</span> regexprep(eccodes{j},<span class="string">'ec-code/|EC'</span>,<span class="string">''</span>) <span class="string">'&quot;/&gt;'</span>];
0521             <span class="keyword">end</span>
0522         <span class="keyword">end</span>
0523         modelSBML.reaction(i).annotation=[modelSBML.reaction(i).annotation <a href="#_sub2" class="code" title="subfunction miriamString=getMiriam(miriamStruct)">getMiriam</a>(model.rxnMiriams{i}) <span class="string">'&lt;/rdf:Bag&gt;&lt;/bqbiol:is&gt;&lt;/rdf:Description&gt;&lt;/rdf:RDF&gt;&lt;/annotation&gt;'</span>];
0524     <span class="keyword">end</span>
0525     
0526     <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'name'</span>)
0527         modelSBML.reaction(i).name=model.rxnNames{i};
0528     <span class="keyword">end</span>
0529     <span class="keyword">if</span> isfield(modelSBML.reaction, <span class="string">'id'</span>)
0530         modelSBML.reaction(i).id=[<span class="string">'R_'</span> model.rxns{i}];
0531     <span class="keyword">end</span>
0532     
0533     <span class="comment">%Add the information about reactants and products</span>
0534     involvedMets=<a href="#_sub3" class="code" title="subfunction [tmp_Rxn]=addReactantsProducts(model,sbmlModel,i)">addReactantsProducts</a>(model,modelSBML,i);
0535     <span class="keyword">for</span> j=1:numel(involvedMets.reactant)
0536         <span class="keyword">if</span> j&lt;numel(involvedMets.reactant)
0537             modelSBML.reaction(i).reactant(j+1)=modelSBML.reaction(i).reactant(j);
0538         <span class="keyword">end</span>
0539         modelSBML.reaction(i).reactant(j).species=involvedMets.reactant(j).species;
0540         modelSBML.reaction(i).reactant(j).stoichiometry=involvedMets.reactant(j).stoichiometry;
0541         modelSBML.reaction(i).reactant(j).isSetStoichiometry=involvedMets.reactant(j).isSetStoichiometry;
0542         modelSBML.reaction(i).reactant(j).constant=involvedMets.reactant(j).constant;
0543     <span class="keyword">end</span>
0544     <span class="keyword">if</span> numel(involvedMets.reactant)==0
0545         modelSBML.reaction(i).reactant=<span class="string">''</span>;
0546     <span class="keyword">end</span>
0547     <span class="keyword">for</span> j=1:numel(involvedMets.product)
0548         <span class="keyword">if</span> j&lt;numel(involvedMets.product)
0549             modelSBML.reaction(i).product(j+1)=modelSBML.reaction(i).product(j);
0550         <span class="keyword">end</span>
0551         modelSBML.reaction(i).product(j).species=involvedMets.product(j).species;
0552         modelSBML.reaction(i).product(j).stoichiometry=involvedMets.product(j).stoichiometry;
0553         modelSBML.reaction(i).product(j).isSetStoichiometry=involvedMets.product(j).isSetStoichiometry;
0554         modelSBML.reaction(i).product(j).constant=involvedMets.product(j).constant;
0555     <span class="keyword">end</span>
0556     <span class="keyword">if</span> numel(involvedMets.product)==0
0557         modelSBML.reaction(i).product=<span class="string">''</span>;
0558     <span class="keyword">end</span>
0559     <span class="comment">%Export reversibility information. Reactions are irreversible by</span>
0560     <span class="comment">%default</span>
0561     <span class="keyword">if</span> model.rev(i)==1
0562         modelSBML.reaction(i).reversible=1;
0563     <span class="keyword">end</span>
0564     <span class="keyword">if</span> isfield(model, <span class="string">'rxnComps'</span>)
0565         modelSBML.reaction(i).compartment=model.comps{model.rxnComps(i)};
0566     <span class="keyword">end</span>
0567     <span class="keyword">if</span> isfield(model, <span class="string">'grRules'</span>)
0568         modelSBML.reaction(i).fbc_geneProductAssociation.fbc_association.fbc_association=model.grRules{i};
0569     <span class="keyword">end</span>
0570     modelSBML.reaction(i).fbc_lowerFluxBound=totalNames{i};
0571     modelSBML.reaction(i).fbc_upperFluxBound=totalNames{length(model.lb)+i};
0572 <span class="keyword">end</span>
0573 
0574 <span class="comment">%Prepare subSystems Code taken from COBRA functions getModelSubSystems,</span>
0575 <span class="comment">%writeSBML, findRxnsFromSubSystem under GNU General Public License v3.0,</span>
0576 <span class="comment">%license file in readme/GPL.MD. Code modified for RAVEN</span>
0577 <span class="keyword">if</span> modelHasSubsystems
0578     modelSBML.groups_group.groups_kind = <span class="string">'partonomy'</span>;
0579     modelSBML.groups_group.sboTerm = 633;
0580     tmpStruct=modelSBML.groups_group;
0581 
0582     rxns=strcat(<span class="string">'R_'</span>,model.rxns);
0583     <span class="keyword">if</span> ~any(cellfun(@iscell,model.subSystems))
0584         <span class="keyword">if</span> ~any(~cellfun(@isempty,model.subSystems))
0585             subSystems = {};
0586         <span class="keyword">else</span>
0587             subSystems = setdiff(model.subSystems,<span class="string">''</span>);
0588         <span class="keyword">end</span>
0589     <span class="keyword">else</span>
0590         orderedSubs = cellfun(@(x) <a href="#_sub4" class="code" title="subfunction vecT = columnVector(vec)">columnVector</a>(x),model.subSystems,<span class="string">'UniformOUtput'</span>,false);
0591         subSystems = setdiff(vertcat(orderedSubs{:}),<span class="string">''</span>);
0592     <span class="keyword">end</span>
0593     <span class="keyword">if</span> isempty(subSystems)
0594         subSystems = {};
0595     <span class="keyword">end</span>
0596     <span class="keyword">if</span> ~isempty(subSystems)
0597         <span class="comment">%Build the groups for the group package</span>
0598         groupIDs = strcat(<span class="string">'group'</span>,cellfun(@num2str, num2cell(1:length(subSystems)),<span class="string">'UniformOutput'</span>,false));
0599         <span class="keyword">for</span> i = 1:length(subSystems)
0600             cgroup = tmpStruct;
0601             <span class="keyword">if</span> ~any(cellfun(@iscell,model.subSystems))
0602                 present = ismember(model.subSystems,subSystems{i});
0603             <span class="keyword">else</span>
0604                 present = cellfun(@(x) any(ismember(x,subSystems{i})),model.subSystems);
0605             <span class="keyword">end</span>
0606             groupMembers = rxns(present);
0607             <span class="keyword">for</span> j = 1:numel(groupMembers)
0608                 cMember = tmpStruct.groups_member;
0609                 cMember.groups_idRef = groupMembers{j};
0610                 <span class="keyword">if</span> j == 1
0611                     cgroup.groups_member = cMember;
0612                 <span class="keyword">else</span>
0613                     cgroup.groups_member(j) = cMember;
0614                 <span class="keyword">end</span>
0615             <span class="keyword">end</span>
0616             cgroup.groups_id = groupIDs{i};
0617             cgroup.groups_name = subSystems{i};
0618             <span class="keyword">if</span> i == 1
0619                 modelSBML.groups_group = cgroup;
0620             <span class="keyword">else</span>
0621                 modelSBML.groups_group(i) = cgroup;
0622             <span class="keyword">end</span>
0623         <span class="keyword">end</span>
0624     <span class="keyword">end</span>
0625 <span class="keyword">end</span>
0626 
0627 <span class="comment">%Prepare fbc_objective subfield</span>
0628 
0629 modelSBML.fbc_objective.fbc_type=<span class="string">'maximize'</span>;
0630 modelSBML.fbc_objective.fbc_id=<span class="string">'obj'</span>;
0631 
0632 ind=find(model.c);
0633 
0634 <span class="keyword">if</span> isempty(ind)
0635     modelSBML.fbc_objective.fbc_fluxObjective.fbc_coefficient=0;
0636 <span class="keyword">else</span>
0637     <span class="keyword">for</span> i=1:length(ind)
0638         <span class="comment">%Copy the default values to the next index as long as it is not the</span>
0639         <span class="comment">%last one</span>
0640         <span class="keyword">if</span> i&lt;numel(ind)
0641             modelSBML.reaction(i+1)=modelSBML.reaction(i);
0642         <span class="keyword">end</span>
0643         values=model.c(model.c~=0);
0644         modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_reaction=modelSBML.reaction(ind(i)).id;
0645         modelSBML.fbc_objective(i).fbc_fluxObjective.fbc_coefficient=values(i);
0646         modelSBML.fbc_objective(i).fbc_fluxObjective.isSetfbc_coefficient=1;
0647     <span class="keyword">end</span>
0648 <span class="keyword">end</span>
0649 
0650 modelSBML.fbc_activeObjective=modelSBML.fbc_objective.fbc_id;
0651 
0652 fbcStr=[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/fbc/version'</span>,num2str(sbmlPackageVersions(1))];
0653 <span class="keyword">if</span> modelHasSubsystems
0654     groupStr=[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/groups/version'</span>,num2str(sbmlPackageVersions(2))];
0655     modelSBML.namespaces=struct(<span class="string">'prefix'</span>,{<span class="string">''</span>,<span class="string">'fbc'</span>,<span class="string">'groups'</span>},<span class="keyword">...</span>
0656     <span class="string">'uri'</span>,{[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/core'</span>],<span class="keyword">...</span>
0657     fbcStr,groupStr});
0658 <span class="keyword">else</span>
0659     modelSBML.namespaces=struct(<span class="string">'prefix'</span>,{<span class="string">''</span>,<span class="string">'fbc'</span>},<span class="keyword">...</span>
0660     <span class="string">'uri'</span>,{[<span class="string">'http://www.sbml.org/sbml/level'</span>, num2str(sbmlLevel), <span class="string">'/version'</span>, num2str(sbmlVersion), <span class="string">'/core'</span>],<span class="keyword">...</span>
0661     fbcStr});
0662 <span class="keyword">end</span>
0663 
0664 <span class="keyword">if</span> sbmlPackageVersions(1) == 2
0665     modelSBML.fbc_strict=1;
0666 <span class="keyword">end</span>
0667 
0668 modelSBML.rule=[];
0669 modelSBML.constraint=[];
0670 
0671 [ravenDir,prevDir]=findRAVENroot();
0672 fileName=<a href="checkFileExistence.html" class="code" title="function files=checkFileExistence(files,fullOrTemp,allowSpace,checkExist)">checkFileExistence</a>(fileName,1,true,false);
0673 cd(fullfile(ravenDir,<span class="string">'software'</span>,<span class="string">'libSBML'</span>));
0674 OutputSBML(modelSBML,fileName,1,0,[1,0]);
0675 cd(prevDir);
0676 <span class="keyword">end</span>
0677 
0678 
0679 <a name="_sub1" href="#_subfunctions" class="code">function modelSBML=getSBMLStructure(sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions)</a>
0680 <span class="comment">%Returns the blank SBML model structure by using appropriate libSBML</span>
0681 <span class="comment">%functions. This creates structure by considering three levels</span>
0682 
0683 sbmlFieldNames=getStructureFieldnames(<span class="string">'model'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0684 sbmlDefaultValues=getDefaultValues(<span class="string">'model'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0685 
0686 <span class="keyword">for</span> i=1:numel(sbmlFieldNames)
0687     modelSBML.(sbmlFieldNames{1,i})=sbmlDefaultValues{1,i};
0688     sbmlSubfieldNames=getStructureFieldnames(sbmlFieldNames{1,i},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0689     sbmlSubfieldValues=getDefaultValues(sbmlFieldNames{1,i},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0690     <span class="keyword">if</span> ~strcmp(sbmlFieldNames{1,i},<span class="string">'event'</span>) &amp;&amp; ~strcmp(sbmlFieldNames{1,i},<span class="string">'functionDefinition'</span>) &amp;&amp; ~strcmp(sbmlFieldNames{1,i},<span class="string">'initialAssignment'</span>)
0691         <span class="keyword">for</span> j=1:numel(sbmlSubfieldNames)
0692             modelSBML.(sbmlFieldNames{1,i}).(sbmlSubfieldNames{1,j})=sbmlSubfieldValues{1,j};
0693             sbmlSubsubfieldNames=getStructureFieldnames(sbmlSubfieldNames{1,j},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0694             sbmlSubsubfieldValues=getDefaultValues(sbmlSubfieldNames{1,j},sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0695             <span class="keyword">if</span> ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'modifier'</span>) &amp;&amp; ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'kineticLaw'</span>)
0696                 <span class="keyword">for</span> k=1:numel(sbmlSubsubfieldNames)
0697                     <span class="comment">%'compartment' and 'species' fields are not supposed to</span>
0698                     <span class="comment">%have their standalone structures if they are subfields</span>
0699                     <span class="comment">%or subsubfields</span>
0700                     <span class="keyword">if</span> ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'compartment'</span>) &amp;&amp; ~strcmp(sbmlSubfieldNames{1,j},<span class="string">'species'</span>)
0701                         modelSBML.(sbmlFieldNames{1,i}).(sbmlSubfieldNames{1,j}).(sbmlSubsubfieldNames{1,k})=sbmlSubsubfieldValues{1,k};
0702                     <span class="keyword">end</span>
0703                     <span class="comment">%If it is fbc_association in the third level, we need</span>
0704                     <span class="comment">%to establish the fourth level, since libSBML requires</span>
0705                     <span class="comment">%it</span>
0706                     <span class="keyword">if</span> strcmp(sbmlSubsubfieldNames{1,k},<span class="string">'fbc_association'</span>)
0707                         fbc_associationFieldNames=getStructureFieldnames(<span class="string">'fbc_association'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0708                         fbc_associationFieldValues=getDefaultValues(<span class="string">'fbc_association'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0709                         <span class="keyword">for</span> l=1:numel(fbc_associationFieldNames)
0710                             modelSBML.(sbmlFieldNames{1,i}).(sbmlSubfieldNames{1,j}).(sbmlSubsubfieldNames{1,k}).(fbc_associationFieldNames{1,l})=fbc_associationFieldValues{1,l};
0711                         <span class="keyword">end</span>
0712                     <span class="keyword">end</span>
0713                 <span class="keyword">end</span>
0714             <span class="keyword">end</span>
0715         <span class="keyword">end</span>
0716     <span class="keyword">end</span>
0717     <span class="keyword">if</span> ~isstruct(modelSBML.(sbmlFieldNames{1,i}))
0718         modelSBML.(sbmlFieldNames{1,i})=sbmlDefaultValues{1,i};
0719     <span class="keyword">end</span>
0720 <span class="keyword">end</span>
0721 
0722 modelSBML.unitDefinition.id=<span class="string">'mmol_per_gDW_per_hr'</span>;
0723 
0724 unitFieldNames=getStructureFieldnames(<span class="string">'unit'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0725 unitDefaultValues=getDefaultValues(<span class="string">'unit'</span>,sbmlLevel,sbmlVersion,sbmlPackages,sbmlPackageVersions);
0726 
0727 kinds={<span class="string">'mole'</span>,<span class="string">'gram'</span>,<span class="string">'second'</span>};
0728 exponents=[1 -1 -1];
0729 scales=[-3 0 0];
0730 multipliers=[1 1 1*60*60];
0731 
0732 <span class="keyword">for</span> i=1:numel(unitFieldNames)
0733     modelSBML.unitDefinition.unit(1).(unitFieldNames{1,i})=unitDefaultValues{1,i};
0734     <span class="keyword">for</span> j=1:3
0735         modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=unitDefaultValues{1,i};
0736         <span class="keyword">if</span> strcmp(unitFieldNames{1,i},<span class="string">'kind'</span>)
0737             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=kinds{j};
0738         <span class="keyword">elseif</span> strcmp(unitFieldNames{1,i},<span class="string">'exponent'</span>)
0739             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=exponents(j);
0740         <span class="keyword">elseif</span> strcmp(unitFieldNames{1,i},<span class="string">'scale'</span>)
0741             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=scales(j);
0742         <span class="keyword">elseif</span> strcmp(unitFieldNames{1,i},<span class="string">'multiplier'</span>)
0743             modelSBML.unitDefinition.unit(j).(unitFieldNames{1,i})=multipliers(j);
0744         <span class="keyword">end</span>
0745     <span class="keyword">end</span>
0746 <span class="keyword">end</span>
0747 <span class="keyword">end</span>
0748 
0749 <a name="_sub2" href="#_subfunctions" class="code">function miriamString=getMiriam(miriamStruct)</a>
0750 <span class="comment">%Returns a string with list elements for a miriam structure ('&lt;rdf:li</span>
0751 <span class="comment">%rdf:resource=&quot;https://identifiers.org/go/GO:0005739&quot;/&gt;' for example). This</span>
0752 <span class="comment">%is just to speed up things since this is done many times during the</span>
0753 <span class="comment">%exporting</span>
0754 
0755 miriamString=<span class="string">''</span>;
0756 <span class="keyword">if</span> isfield(miriamStruct,<span class="string">'name'</span>)
0757     <span class="keyword">for</span> i=1:numel(miriamStruct.name)
0758         miriamString=[miriamString <span class="string">'&lt;rdf:li rdf:resource=&quot;https://identifiers.org/'</span> miriamStruct.name{i} <span class="string">'/'</span> miriamStruct.value{i} <span class="string">'&quot;/&gt;'</span>];
0759     <span class="keyword">end</span>
0760 <span class="keyword">end</span>
0761 <span class="keyword">end</span>
0762 
0763 <a name="_sub3" href="#_subfunctions" class="code">function [tmp_Rxn]=addReactantsProducts(model,sbmlModel,i)</a>
0764 <span class="comment">%This function provides reactants and products for particular reaction. The</span>
0765 <span class="comment">%function was 'borrowed' from writeSBML in COBRA toolbox, lines 663-679</span>
0766 
0767 met_idx = find(model.S(:, i));
0768 tmp_Rxn.product=[];
0769 tmp_Rxn.reactant=[];
0770 <span class="keyword">for</span> j_met=1:size(met_idx,1)
0771     tmp_idx = met_idx(j_met,1);
0772     sbml_tmp_species_ref.species = sbmlModel.species(tmp_idx).id;
0773     met_stoich = model.S(tmp_idx, i);
0774     sbml_tmp_species_ref.stoichiometry = abs(met_stoich);
0775     sbml_tmp_species_ref.isSetStoichiometry=1;
0776     sbml_tmp_species_ref.constant=1;
0777     <span class="keyword">if</span> (met_stoich &gt; 0)
0778         tmp_Rxn.product = [ tmp_Rxn.product, sbml_tmp_species_ref ];
0779     <span class="keyword">else</span>
0780         tmp_Rxn.reactant = [ tmp_Rxn.reactant, sbml_tmp_species_ref];
0781     <span class="keyword">end</span>
0782 <span class="keyword">end</span>
0783 <span class="keyword">end</span>
0784 
0785 <a name="_sub4" href="#_subfunctions" class="code">function vecT = columnVector(vec)</a>
0786 <span class="comment">% Code below taken from COBRA Toolbox under GNU General Public License v3.0</span>
0787 <span class="comment">% license file in readme/GPL.MD.</span>
0788 <span class="comment">%</span>
0789 <span class="comment">% Converts a vector to a column vector</span>
0790 <span class="comment">%</span>
0791 <span class="comment">% USAGE:</span>
0792 <span class="comment">%</span>
0793 <span class="comment">%   vecT = columnVector(vec)</span>
0794 <span class="comment">%</span>
0795 <span class="comment">% INPUT:</span>
0796 <span class="comment">%   vec:     a vector</span>
0797 <span class="comment">%</span>
0798 <span class="comment">% OUTPUT:</span>
0799 <span class="comment">%   vecT:    a column vector</span>
0800 
0801 [n, m] = size(vec);
0802 
0803 <span class="keyword">if</span> n &lt; m
0804     vecT = vec';
0805 <span class="keyword">else</span>
0806     vecT = vec;
0807 <span class="keyword">end</span>
0808 <span class="keyword">end</span></pre></div>
<hr><address>Generated by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>